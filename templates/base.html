<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Calendar to Harvest Integration{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">

    <!-- CSRF Token for AJAX requests -->
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <style>
        .navbar-brand {
            font-weight: bold;
        }
        .main-content {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .status-badge {
            font-size: 0.875rem;
        }
        .setup-card {
            border-left: 4px solid #007bff;
        }
        .mapping-card {
            border-left: 4px solid #28a745;
        }
        .process-card {
            border-left: 4px solid #ffc107;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="bi bi-calendar-check"></i>
                Calendar ‚Üí Harvest
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="bi bi-house"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('setup') }}">
                            <i class="bi bi-gear"></i> Setup
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('mappings') }}">
                            <i class="bi bi-diagram-3"></i> Mappings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('process') }}">
                            <i class="bi bi-play-circle"></i> Process
                        </a>
                    </li>
                </ul>

                <!-- User menu -->
                {% if session.user_id %}
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            {% if session.user_name %}
                                <i class="bi bi-person-circle"></i> {{ session.user_name }}
                            {% else %}
                                <i class="bi bi-person-circle"></i> User
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">{{ session.user_email or 'User Account' }}</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Flash Messages - Positioned to center of screen -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages-container">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show flash-message" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <div class="container main-content">
        {% block content %}{% endblock %}
    </div>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <p class="text-muted mb-0">
                Calendar to Harvest Integration Tool
                <span class="mx-2">‚Ä¢</span>
                <small>Automatically sync your calendar events to Harvest timesheets</small>
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- CSRF Protection -->
    <script src="{{ url_for('static', filename='js/csrf.js') }}"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <!-- Persistent Login Script -->
    <script>
        // Store auth token from template if available
        const AUTH_TOKEN = '{{ auth_token }}';

        // Add token to all navigation links
        function addTokenToNavigationLinks() {
            const token = localStorage.getItem('persistent_token');
            if (!token) {
                console.log('‚ö†Ô∏è  No token to add to navigation links');
                return;
            }

            console.log('üîó Adding token to navigation links...');

            // Get all navigation links
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.includes('?token=') && !href.startsWith('http')) {
                    // Add token as query parameter
                    const separator = href.includes('?') ? '&' : '?';
                    link.setAttribute('href', `${href}${separator}token=${token}`);
                    console.log(`   - Updated link: ${href} ‚Üí ${href}${separator}token=${token.substring(0, 20)}...`);
                }
            });

            console.log('‚úÖ Navigation links updated with token');
        }

        // Check authentication on page load
        async function checkAuthenticationOnPageLoad() {
            console.log('='.repeat(70));
            console.log('üîç BASE.HTML AUTHENTICATION CHECK - Page: {{ request.path }}');
            console.log('='.repeat(70));
            console.log('üìã State:');
            console.log('   - AUTH_TOKEN from server:', AUTH_TOKEN ? AUTH_TOKEN.substring(0, 20) + '...' : 'None');

            const storedToken = localStorage.getItem('persistent_token');
            console.log('   - Stored token:', storedToken ? storedToken.substring(0, 20) + '...' : 'None');
            console.log('='.repeat(70));

            // If we have auth_token from the server, we're authenticated
            if (AUTH_TOKEN && AUTH_TOKEN !== 'None') {
                console.log('‚úÖ Auth token from server, storing in localStorage');
                localStorage.setItem('persistent_token', AUTH_TOKEN);
                console.log('‚úÖ Token stored successfully');
                // Add token to navigation links
                addTokenToNavigationLinks();
                return;
            }

            // Check localStorage for persistent token
            if (!storedToken) {
                console.log('‚ùå No token found in localStorage, redirecting to login');
                window.location.href = '/';
                return;
            }

            console.log('üîÑ Token found in localStorage, verifying...');
            // Add token to navigation links
            addTokenToNavigationLinks();

            // Verify token is still valid
            try {
                const response = await fetch('/api/auth/verify-token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ token: storedToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (!data.authenticated) {
                        console.log('Token verification failed, redirecting to login');
                        localStorage.removeItem('persistent_token');
                        window.location.href = '/';
                    } else {
                        console.log('‚úÖ Token verified, user authenticated');
                        // Add token to navigation links
                        addTokenToNavigationLinks();
                    }
                } else {
                    console.log('Token verification error, redirecting to login');
                    localStorage.removeItem('persistent_token');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error verifying token:', error);
                window.location.href = '/';
            }
        }

        // Run authentication check on page load
        document.addEventListener('DOMContentLoaded', checkAuthenticationOnPageLoad);
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
