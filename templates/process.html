{% extends "base.html" %}

{% block title %}Process Timesheets - Calendar to Harvest Integration{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-play-circle"></i>
            Process Timesheets
        </h1>
        <p class="lead text-muted mb-5">
            Select a week to process and preview the timesheet entries that will be created in Harvest.
        </p>
    </div>
</div>

<!-- Week Selection -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card process-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-week"></i>
                    Select Week
                </h5>
            </div>
            <div class="card-body">
                <div class="week-selector">
                    <div class="week-nav">
                        <button class="btn btn-outline-primary week-prev" type="button">
                            <i class="bi bi-chevron-left"></i>
                            Previous Week
                        </button>
                        
                        <div class="week-display-container">
                            <div class="week-display" id="current-week" data-week-start="">
                                <!-- Week display will be populated here -->
                            </div>
                            <div class="week-info" id="week-info">
                                <!-- Additional week info will be populated here -->
                            </div>
                        </div>
                        
                        <button class="btn btn-outline-primary week-next" type="button">
                            <i class="bi bi-chevron-right"></i>
                            Next Week
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-primary" onclick="loadCurrentWeek()">
                                <i class="bi bi-calendar-today"></i>
                                Current Week
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="refreshWeekEvents()">
                                <i class="bi bi-arrow-clockwise"></i>
                                Refresh Events
                            </button>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="form-check form-switch d-inline-block me-3">
                                <input class="form-check-input" type="checkbox" id="includeWeekends" checked>
                                <label class="form-check-label" for="includeWeekends">
                                    Include weekends
                                </label>
                            </div>
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input" type="checkbox" id="showAllEvents">
                                <label class="form-check-label" for="showAllEvents">
                                    Show processed events
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Events Preview -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-event"></i>
                    Calendar Events
                </h5>
                <span class="badge bg-info" id="events-count">0 events</span>
            </div>
            <div class="card-body">
                <div id="events-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading calendar events...</p>
                </div>

                <div id="events-empty" class="text-center py-4" style="display: none;">
                    <i class="bi bi-calendar-x display-4 text-muted"></i>
                    <h5 class="mt-3 text-muted">No Events Found</h5>
                    <p class="text-muted">
                        No calendar events found for the selected week.
                    </p>
                </div>

                <div id="events-container">
                    <!-- Events will be populated here -->
                </div>

                <!-- Show More/Less button for events -->
                <div id="events-show-more" class="text-center mt-3" style="display: none;">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleEventsDisplay()">
                        <i class="bi bi-chevron-down"></i> Show More Events
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Timesheet Preview -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-stopwatch"></i>
                    Timesheet Preview
                </h5>
                <span class="badge bg-success" id="timesheet-count">0 entries</span>
            </div>
            <div class="card-body">
                <div id="timesheet-loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Generating timesheet preview...</p>
                </div>

                <div id="timesheet-empty" class="text-center py-4">
                    <i class="bi bi-clock display-4 text-muted"></i>
                    <h5 class="mt-3 text-muted">No Timesheet Entries</h5>
                    <p class="text-muted">
                        Load calendar events to see proposed timesheet entries.
                    </p>
                </div>

                <div id="timesheet-container">
                    <!-- Timesheet entries will be populated here -->
                </div>

                <!-- Show More/Less button for timesheet entries -->
                <div id="timesheet-show-more" class="text-center mt-3" style="display: none;">
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleTimesheetDisplay()">
                        <i class="bi bi-chevron-down"></i> Show More Entries
                    </button>
                </div>

                <div id="timesheet-summary" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <div class="row text-center">
                            <div class="col-3">
                                <strong id="total-hours">0</strong><br>
                                <small class="text-muted">Total Hours</small>
                            </div>
                            <div class="col-3">
                                <strong id="mapped-events">0</strong><br>
                                <small class="text-muted">Mapped Events</small>
                            </div>
                            <div class="col-3">
                                <strong id="unmapped-events">0</strong><br>
                                <small class="text-muted">Unmapped Events</small>
                            </div>
                            <div class="col-3">
                                <strong id="grouped-entries">0</strong><br>
                                <small class="text-muted">Final Entries</small>
                            </div>
                        </div>
                        <div id="grouping-details" class="mt-2" style="display: none;">
                            <hr class="my-2">
                            <div class="text-center">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    <span id="grouping-message">Events grouped by project, task, and date</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Unmapped Events Section -->
<div class="row mb-4" id="unmapped-events-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    Unmapped Events
                </h5>
                <span class="badge bg-warning" id="unmapped-count">0 events</span>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    The following events don't have project mappings. Assign mappings to include them in your timesheet.
                </p>

                <!-- Bulk Assignment Controls -->
                <div id="bulk-assignment-controls" class="mb-4 p-3 bg-light rounded" style="display: none;">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="select-all-events">
                                <label class="form-check-label" for="select-all-events">
                                    <strong>Select All</strong>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="bulk-project-select">
                                <option value="">Select Project...</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="bulk-task-select" disabled>
                                <option value="">Select Task...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary" id="bulk-assign-btn" disabled>
                                <i class="bi bi-check2-square"></i>
                                Assign to Selected (<span id="selected-count">0</span>)
                            </button>
                        </div>
                    </div>
                </div>

                <div id="unmapped-events-container">
                    <!-- Unmapped events will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Process Actions -->
<div class="row" id="process-actions" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    Process Options
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="forceOverwrite">
                            <label class="form-check-label" for="forceOverwrite">
                                <strong>Force overwrite existing timesheet entries</strong>
                                <small class="text-muted d-block">⚠️ This will replace any existing entries for this week</small>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="roundHours" checked>
                            <label class="form-check-label" for="roundHours">
                                Round hours up to nearest 30 minutes
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="dryRun">
                            <label class="form-check-label" for="dryRun">
                                <i class="bi bi-eye"></i>
                                Preview mode (show Harvest timesheet simulation)
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="d-flex flex-column align-items-end gap-2">
                            <button class="btn btn-success btn-lg" onclick="processTimesheets()" id="process-btn">
                                <i class="bi bi-play-fill"></i>
                                Process Timesheets
                                <div class="small" id="process-week-indicator" style="opacity: 0.8; margin-top: 2px;">
                                    <!-- Week indicator will be populated here -->
                                </div>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="showExistingEntriesInHarvest()" title="Check what entries already exist in Harvest for this week">
                                <i class="bi bi-search"></i> Check Existing Entries
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Important:</strong> This will create new timesheet entries in your Harvest account. 
                    Make sure to review the preview above before proceeding.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Processing Status Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-gear-fill"></i>
                    Processing Timesheets
                </h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="progress-bar">
                    </div>
                </div>
                
                <div id="processing-status">
                    <p class="mb-1">Initializing...</p>
                </div>
                
                <div id="processing-results" style="display: none;">
                    <!-- Results will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                        id="close-processing" style="display: none;">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('🔧 DEBUG: Process.html script is loading...');

let currentWeekStart = null;
let currentEvents = [];
let currentTimesheetEntries = [];
let currentUnmappedEvents = [];
let availableProjects = [];
let currentRequestId = 0; // Track the latest request to prevent race conditions
let navigationTimeout = null; // Debounce navigation
let eventsCache = new Map(); // Cache events by week to improve performance
let activeRequest = null; // Track active request to cancel if needed
const MAX_CACHE_SIZE = 10; // Limit cache to 10 weeks to prevent memory issues
let processingModal;

document.addEventListener('DOMContentLoaded', function() {
    processingModal = new bootstrap.Modal(document.getElementById('processingModal'));
    loadCurrentWeek();
    loadAvailableProjects();

    // Add event listener for "Show processed events" toggle
    document.getElementById('showAllEvents').addEventListener('change', function() {
        console.log('Show all events toggle changed:', this.checked);
        // Regenerate timesheet preview when toggle changes
        if (currentEvents.length > 0) {
            generateTimesheetPreview();
        }
    });
});

function loadAvailableProjects() {
    return fetch('/api/harvest/projects')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                availableProjects = data.projects || [];
                console.log('Loaded projects:', availableProjects.length);
                // Refresh unmapped events display if there are any
                if (currentUnmappedEvents.length > 0) {
                    displayUnmappedEvents();
                }
            } else {
                console.error('Failed to load projects:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading projects:', error);
        });
}

function loadCurrentWeek() {
    // Get Monday of current week
    const today = new Date();
    const monday = new Date(today);
    monday.setDate(today.getDate() - today.getDay() + 1);

    setCurrentWeek(monday);
    loadWeekEvents();
}

function clearEventsCache() {
    eventsCache.clear();
    console.log('Events cache cleared');
}

function getCacheStats() {
    console.log(`Events cache contains ${eventsCache.size} weeks:`, Array.from(eventsCache.keys()));
}

function refreshWeekEvents() {
    if (!currentWeekStart) return;

    const weekStartStr = formatDate(currentWeekStart);

    // Remove current week from cache to force refresh
    eventsCache.delete(weekStartStr);

    console.log(`Refreshing events for week ${weekStartStr}`);
    loadWeekEvents();
}

function filterEventsForWeek(events, weekStart) {
    if (!events || !weekStart) {
        console.log('filterEventsForWeek: No events or weekStart provided');
        return [];
    }

    const weekStartStr = formatDate(weekStart);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    weekEnd.setHours(23, 59, 59, 999);

    console.log(`Filtering ${events.length} events for week ${weekStartStr} (${weekStart.toDateString()} to ${weekEnd.toDateString()})`);

    const filteredEvents = events.filter(event => {
        if (!event.start) {
            console.log(`Filtering out event "${event.summary || 'Unknown'}" - no start time`);
            return false;
        }

        // Parse event start date
        let eventDate;
        try {
            if (event.start.includes('T')) {
                // DateTime format
                eventDate = new Date(event.start);
            } else {
                // Date-only format
                eventDate = new Date(event.start + 'T00:00:00');
            }
        } catch (e) {
            console.warn(`Could not parse event date for "${event.summary || 'Unknown'}":`, event.start);
            return false;
        }

        // Check if event date falls within the week (strict date comparison)
        const eventDateOnly = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
        const weekStartOnly = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
        const weekEndOnly = new Date(weekEnd.getFullYear(), weekEnd.getMonth(), weekEnd.getDate());

        const isInWeek = eventDateOnly >= weekStartOnly && eventDateOnly <= weekEndOnly;

        if (!isInWeek) {
            console.log(`❌ Filtering out event "${event.summary || 'Unknown'}" - date ${eventDate.toDateString()} not in week ${weekStart.toDateString()} to ${weekEnd.toDateString()}`);
        } else {
            console.log(`✅ Including event "${event.summary || 'Unknown'}" - date ${eventDate.toDateString()}`);
        }

        return isInWeek;
    });

    console.log(`Filtered result: ${filteredEvents.length} events for week ${weekStartStr}`);
    return filteredEvents;
}

function setCurrentWeek(weekStart) {
    currentWeekStart = weekStart;
    console.log('Setting current week to:', formatDate(weekStart));

    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);

    const weekDisplay = document.getElementById('current-week');
    const weekInfo = document.getElementById('week-info');

    // Format dates in DD-MM-YYYY format for display
    const startFormatted = formatDateDisplay(weekStart);
    const endFormatted = formatDateDisplay(weekEnd);

    // Add fade effect for smooth transition
    weekDisplay.style.opacity = '0.5';
    weekInfo.style.opacity = '0.5';

    setTimeout(() => {
        // Create enhanced week display
        weekDisplay.innerHTML = `
            <div class="week-period">
                <i class="bi bi-calendar-range"></i>
                <span class="week-dates">${startFormatted} - ${endFormatted}</span>
            </div>
        `;

        // Add additional week information
        const weekNumber = getWeekNumber(weekStart);
        const monthYear = weekStart.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
        const isCurrentWeek = isCurrentWeekCheck(weekStart);

        // Get day names for the week
        const startDayName = weekStart.toLocaleDateString('en-GB', { weekday: 'short' });
        const endDayName = weekEnd.toLocaleDateString('en-GB', { weekday: 'short' });

        weekInfo.innerHTML = `
            <div class="week-details">
                <span class="week-number">Week ${weekNumber}</span>
                <span class="week-month">${monthYear}</span>
                <span class="week-days">${startDayName} - ${endDayName}</span>
                ${isCurrentWeek ? '<span class="badge bg-primary ms-2">Current Week</span>' : ''}
            </div>
        `;

        weekDisplay.dataset.weekStart = formatDateISO(weekStart);

        // Update process button indicator
        const processIndicator = document.getElementById('process-week-indicator');
        if (processIndicator) {
            processIndicator.textContent = `Week: ${startFormatted} - ${endFormatted}`;
        }

        // Fade back in
        weekDisplay.style.opacity = '1';
        weekInfo.style.opacity = '1';
    }, 150);
}

function loadWeekEvents() {
    if (!currentWeekStart) return;

    const weekStartStr = formatDate(currentWeekStart);

    // Cancel any active request
    if (activeRequest) {
        activeRequest.abort();
        activeRequest = null;
    }

    // Check cache first
    if (eventsCache.has(weekStartStr)) {
        console.log(`Loading events from cache for week ${weekStartStr}`);
        const cachedEvents = eventsCache.get(weekStartStr);
        currentEvents = cachedEvents;
        displayEvents();

        // Generate timesheet preview and hide events loader when complete
        generateTimesheetPreview().finally(() => {
            document.getElementById('events-loading').style.display = 'none';
        });
        return;
    }

    // Increment request ID to track this specific request
    currentRequestId++;
    const thisRequestId = currentRequestId;

    document.getElementById('events-loading').style.display = 'block';
    document.getElementById('events-empty').style.display = 'none';
    document.getElementById('events-container').innerHTML = '';

    console.log(`Loading events from API for week ${weekStartStr} (request ID: ${thisRequestId})`);

    // Create AbortController for this request
    const controller = new AbortController();
    activeRequest = controller;

    fetch(`/api/calendar/events?week_start=${weekStartStr}`, {
        signal: controller.signal
    })
        .then(response => {
            console.log('🔧 DEBUG: Calendar API response status:', response.status);
            console.log('🔧 DEBUG: Calendar API response headers:', response.headers);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('🔧 DEBUG: Calendar API response data:', data);
            console.log('🔧 DEBUG: Request ID check - thisRequestId:', thisRequestId, 'currentRequestId:', currentRequestId);

            // Only process this response if it's still the most recent request
            if (thisRequestId !== currentRequestId) {
                console.log(`Ignoring outdated response for request ${thisRequestId}, current is ${currentRequestId}`);
                return;
            }

            if (data.success) {
                console.log('🔧 DEBUG: API success, raw events count:', (data.events || []).length);

                // Strict filtering to ensure only events from the exact week are included
                const filteredEvents = filterEventsForWeek(data.events || [], currentWeekStart);
                console.log('🔧 DEBUG: Filtered events count:', filteredEvents.length);

                // Cache the filtered events with size limit
                if (eventsCache.size >= MAX_CACHE_SIZE) {
                    // Remove oldest entry
                    const firstKey = eventsCache.keys().next().value;
                    eventsCache.delete(firstKey);
                }
                eventsCache.set(weekStartStr, filteredEvents);

                // Only update if this is still the current week
                console.log('🔧 DEBUG: Week check - formatDate(currentWeekStart):', formatDate(currentWeekStart), 'weekStartStr:', weekStartStr);
                if (formatDate(currentWeekStart) === weekStartStr) {
                    currentEvents = filteredEvents;
                    console.log(`✅ Loaded ${filteredEvents.length} events for week ${weekStartStr}`);
                    displayEvents();

                    // Generate timesheet preview - the events loader will be hidden when preview completes
                    generateTimesheetPreview().finally(() => {
                        // Hide events loading indicator after timesheet preview is complete
                        if (thisRequestId === currentRequestId) {
                            document.getElementById('events-loading').style.display = 'none';
                        }
                    });
                } else {
                    console.log('🔧 DEBUG: Week mismatch, not updating currentEvents');
                }
            } else {
                console.log('🔧 DEBUG: API returned error:', data.error);
                CalendarHarvestApp.showError(data.error || 'Failed to load calendar events');
            }
        })
        .catch(error => {
            console.log('🔧 DEBUG: Calendar API error caught:', error);
            console.log('🔧 DEBUG: Error name:', error.name);
            console.log('🔧 DEBUG: Error message:', error.message);
            console.log('🔧 DEBUG: Request ID check - thisRequestId:', thisRequestId, 'currentRequestId:', currentRequestId);

            // Only show error if this is still the current request and not aborted
            if (thisRequestId === currentRequestId && error.name !== 'AbortError') {
                console.error('❌ Error loading events:', error);
                CalendarHarvestApp.showError('Failed to load calendar events: ' + error.message);
            } else {
                console.log('🔧 DEBUG: Error ignored (outdated request or aborted)');
            }
        })
        .finally(() => {
            // Clear active request if it's this one
            if (activeRequest === controller) {
                activeRequest = null;
            }
            // Note: events-loading will be hidden after timesheet preview completes
        });
}

function displayEvents() {
    const container = document.getElementById('events-container');
    const countElement = document.getElementById('events-count');
    
    countElement.textContent = `${currentEvents.length} event${currentEvents.length !== 1 ? 's' : ''}`;
    
    if (currentEvents.length === 0) {
        document.getElementById('events-empty').style.display = 'block';
        return;
    }
    
    container.innerHTML = '';
    
    currentEvents.forEach((event, index) => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event-preview';

        // Initially hide events beyond MAX_VISIBLE_ITEMS if collapsed
        if (eventsCollapsed && index >= MAX_VISIBLE_ITEMS) {
            eventDiv.style.display = 'none';
        }

        const startTime = new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const endTime = new Date(event.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const eventDate = new Date(event.start).toLocaleDateString('en-GB', {weekday: 'short', day: '2-digit', month: 'short'});

        // Create badges for mapping and recurring status
        let recurringBadge = '';
        let mappingBadge = '';

        if (event.is_recurring) {
            recurringBadge = `<span class="badge bg-info"><i class="bi bi-arrow-repeat"></i> Recurring</span>`;
        }

        if (event.mapping) {
            mappingBadge = `<span class="badge bg-success">${event.mapping}</span>`;
        } else if (event.extracted_label) {
            // Use calendar label with CSS class
            mappingBadge = `<span class="badge ${CalendarHarvestApp.getLabelCssClass(event.extracted_label)}">${event.extracted_label}</span>`;
        } else {
            mappingBadge = `<span class="badge bg-secondary">No mapping</span>`;
        }

        // Calculate rounded duration (round up to nearest 0.5 hours)
        const roundedDuration = Math.ceil(event.duration * 2) / 2;

        eventDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${event.summary}</h6>
                    <div class="event-time">${eventDate} • ${startTime} - ${endTime}</div>
                    <div class="event-duration">
                        ${event.duration}h → <strong>${roundedDuration}h</strong>
                        <small class="text-muted">(rounded up)</small>
                    </div>
                    ${event.description ? `<small class="text-muted">${event.description.substring(0, 100)}${event.description.length > 100 ? '...' : ''}</small>` : ''}
                </div>
                <div class="text-end ms-2">
                    ${recurringBadge}
                    ${mappingBadge}
                </div>
            </div>
        `;

        container.appendChild(eventDiv);
    });

    // Show/hide the "Show More" button based on number of events
    const showMoreButton = document.getElementById('events-show-more');
    if (currentEvents.length > MAX_VISIBLE_ITEMS) {
        showMoreButton.style.display = 'block';
        // Reset button text based on current state
        const button = showMoreButton.querySelector('button');
        if (eventsCollapsed) {
            button.innerHTML = '<i class="bi bi-chevron-down"></i> Show More Events';
        } else {
            button.innerHTML = '<i class="bi bi-chevron-up"></i> Show Less Events';
        }
    } else {
        showMoreButton.style.display = 'none';
    }
}

function generateTimesheetPreview() {
    console.log('🔧 DEBUG: generateTimesheetPreview called');
    console.log('🔧 DEBUG: currentEvents.length:', currentEvents.length);
    console.log('🔧 DEBUG: currentWeekStart:', currentWeekStart);

    // Show timesheet loading indicator
    document.getElementById('timesheet-loading').style.display = 'block';
    document.getElementById('timesheet-empty').style.display = 'none';
    document.getElementById('timesheet-container').innerHTML = '';

    if (currentEvents.length === 0) {
        console.log('🔧 DEBUG: No events found, showing empty state');
        document.getElementById('timesheet-loading').style.display = 'none';
        document.getElementById('timesheet-empty').style.display = 'block';
        document.getElementById('timesheet-summary').style.display = 'none';
        document.getElementById('process-actions').style.display = 'none';
        return;
    }

    const weekStartFormatted = formatDate(currentWeekStart);

    // Double-check that events belong to the current week before processing
    const filteredEvents = filterEventsForWeek(currentEvents, currentWeekStart);

    console.log('Generating timesheet preview for week:', weekStartFormatted);
    console.log('Current events count:', currentEvents.length);
    console.log('Filtered events count:', filteredEvents.length);
    console.log('Sample event dates:', filteredEvents.slice(0, 3).map(e => ({summary: e.summary, start: e.start})));

    // Check if user wants to show all events (including processed ones)
    const showAllEvents = document.getElementById('showAllEvents').checked;

    return fetch('/api/process/preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            week_start: weekStartFormatted,
            events: filteredEvents,
            show_all_events: showAllEvents
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('=== TIMESHEET PREVIEW RESPONSE ===');
        console.log('Preview response:', data);

        if (data.success) {
            currentTimesheetEntries = data.timesheet_entries || [];
            currentUnmappedEvents = data.unmapped_events_details || [];

            console.log('Timesheet entries from preview:', currentTimesheetEntries);
            console.log('Unmapped events from preview:', currentUnmappedEvents);

            displayTimesheetPreview(data);

            // Ensure projects are loaded before displaying unmapped events
            if (availableProjects.length === 0) {
                loadAvailableProjects().then(() => {
                    displayUnmappedEvents();
                });
            } else {
                displayUnmappedEvents();
            }
        } else {
            console.log('❌ Preview failed:', data.error);
            CalendarHarvestApp.showError(data.error || 'Failed to generate timesheet preview');
        }
    })
    .catch(error => {
        console.error('Error generating preview:', error);
        CalendarHarvestApp.showError('Failed to generate timesheet preview');
    })
    .finally(() => {
        // Hide timesheet loading indicator
        document.getElementById('timesheet-loading').style.display = 'none';
    });
}

function displayTimesheetPreview(data) {
    const container = document.getElementById('timesheet-container');
    const countElement = document.getElementById('timesheet-count');
    const summaryElement = document.getElementById('timesheet-summary');
    const actionsElement = document.getElementById('process-actions');

    // Hide loading indicator
    document.getElementById('timesheet-loading').style.display = 'none';

    countElement.textContent = `${data.timesheet_entries.length} entr${data.timesheet_entries.length !== 1 ? 'ies' : 'y'}`;

    if (data.timesheet_entries.length === 0) {
        document.getElementById('timesheet-empty').style.display = 'block';
        summaryElement.style.display = 'none';
        actionsElement.style.display = 'none';
        return;
    }

    document.getElementById('timesheet-empty').style.display = 'none';
    
    // Display timesheet entries
    container.innerHTML = '';
    
    data.timesheet_entries.forEach((entry, index) => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'timesheet-preview';

        // Initially hide entries beyond MAX_VISIBLE_ITEMS if collapsed
        if (timesheetCollapsed && index >= MAX_VISIBLE_ITEMS) {
            entryDiv.style.display = 'none';
        }

        entryDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${entry.project_name}</h6>
                    <div class="text-muted">${entry.task_name}</div>
                    <div class="mt-1">
                        <small class="text-muted">${entry.spent_date} • ${entry.hours}h</small>
                        ${entry.mapping_label ? createColoredBadge(entry.mapping_label) : ''}
                    </div>
                    ${entry.event_summary ? `<small class="text-muted d-block mt-1"><strong>Event:</strong> ${entry.event_summary}</small>` : ''}
                    ${entry.notes && entry.notes !== entry.event_summary ? `<small class="text-muted d-block mt-1">${entry.notes.substring(0, 150)}${entry.notes.length > 150 ? '...': ''}</small>` : ''}
                </div>
                <div class="text-end ms-2">
                    <span class="badge bg-warning">${entry.hours}h</span>
                </div>            </div>
        `;

        container.appendChild(entryDiv);
    });

    // Show/hide the "Show More" button based on number of entries
    const showMoreButton = document.getElementById('timesheet-show-more');
    if (data.timesheet_entries.length > MAX_VISIBLE_ITEMS) {
        showMoreButton.style.display = 'block';
        // Reset button text based on current state
        const button = showMoreButton.querySelector('button');
        if (timesheetCollapsed) {
            button.innerHTML = '<i class="bi bi-chevron-down"></i> Show More Entries';
        } else {
            button.innerHTML = '<i class="bi bi-chevron-up"></i> Show Less Entries';
        }
    } else {
        showMoreButton.style.display = 'none';
    }
    
    // Update summary
    const totalHours = data.timesheet_entries.reduce((sum, entry) => sum + entry.hours, 0);
    document.getElementById('total-hours').textContent = totalHours.toFixed(2);
    document.getElementById('mapped-events').textContent = data.mapped_events;
    document.getElementById('unmapped-events').textContent = data.unmapped_events;
    
    // Update summary information for individual entries
    if (data.summary_info) {
        document.getElementById('grouped-entries').textContent = data.summary_info.total_entries;
    } else {
        document.getElementById('grouped-entries').textContent = data.timesheet_entries.length;
    }

    // Hide grouping details since we're showing individual entries
    const groupingDetails = document.getElementById('grouping-details');
    if (groupingDetails) {
        groupingDetails.style.display = 'none';
    }
    
    summaryElement.style.display = 'block';
    actionsElement.style.display = 'block';}

function displayUnmappedEvents() {
    const unmappedSection = document.getElementById('unmapped-events-section');
    const unmappedContainer = document.getElementById('unmapped-events-container');
    const unmappedCount = document.getElementById('unmapped-count');

    console.log('displayUnmappedEvents called:', {
        unmappedEventsCount: currentUnmappedEvents.length,
        availableProjectsCount: availableProjects.length
    });

    if (currentUnmappedEvents.length === 0) {
        unmappedSection.style.display = 'none';
        return;
    }

    if (availableProjects.length === 0) {
        console.warn('No projects available for unmapped events dropdowns');
    }

    unmappedCount.textContent = `${currentUnmappedEvents.length} event${currentUnmappedEvents.length !== 1 ? 's' : ''}`;
    unmappedContainer.innerHTML = '';

    currentUnmappedEvents.forEach((event, index) => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'unmapped-event mb-3 p-3 border rounded';

        const startTime = new Date(event.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const endTime = new Date(event.end).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const eventDate = new Date(event.start).toLocaleDateString('en-GB', {weekday: 'short', day: '2-digit', month: 'short'});

        // Create badges for recurring status and calendar label
        const recurringBadge = event.is_recurring ?
            `<span class="badge bg-info me-2"><i class="bi bi-arrow-repeat"></i> Recurring</span>` : '';

        const labelBadge = event.extracted_label ?
            `<span class="badge me-2 ${CalendarHarvestApp.getLabelCssClass(event.extracted_label)}">${event.extracted_label}</span>` : '';



        eventDiv.innerHTML = `
            <div class="row align-items-center">
                <div class="col-md-1">
                    <div class="form-check">
                        <input class="form-check-input event-checkbox" type="checkbox" id="event-checkbox-${index}" data-event-index="${index}" onchange="updateBulkControls()">
                        <label class="form-check-label" for="event-checkbox-${index}"></label>
                    </div>
                </div>
                <div class="col-md-5">
                    <h6 class="mb-1">
                        ${event.summary}
                        ${labelBadge}
                        ${recurringBadge}
                    </h6>
                    <div class="text-muted small">${eventDate} • ${startTime} - ${endTime} • ${event.duration}h</div>
                    ${event.recurrence_pattern ? `<div class="text-muted small"><i class="bi bi-calendar-event"></i> ${event.recurrence_pattern}</div>` : ''}
                    ${event.description ? `<div class="text-muted small mt-1">${event.description.substring(0, 100)}${event.description.length > 100 ? '...' : ''}</div>` : ''}
                </div>
                <div class="col-md-4">
                    <select class="form-select form-select-sm" id="project-select-${index}" onchange="updateTaskOptions(${index})">
                        <option value="">Select Project...</option>
                        ${availableProjects.length > 0 ?
                            availableProjects.map(project =>
                                `<option value="${project.id}">${project.name} (${project.client_name})</option>`
                            ).join('') :
                            '<option value="" disabled>No projects available</option>'
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-info btn-sm w-100 mb-1" onclick="getPatternSuggestions(${index})" id="suggest-btn-${index}">
                        <i class="bi bi-lightbulb"></i> Suggest
                    </button>
                    <button class="btn btn-primary btn-sm w-100" onclick="assignMapping(${index})" id="assign-btn-${index}" disabled>
                        <i class="bi bi-plus-circle"></i> Assign
                    </button>
                </div>
            </div>
            <div class="row mt-2" id="task-row-${index}" style="display: none;">
                <div class="col-md-5 offset-md-1">
                    <select class="form-select form-select-sm" id="task-select-${index}">
                        <option value="">Select Task...</option>
                    </select>
                </div>
            </div>
        `;

        unmappedContainer.appendChild(eventDiv);
    });

    unmappedSection.style.display = 'block';

    // Initialize bulk controls
    initializeBulkControls();
}

function initializeBulkControls() {
    const bulkControls = document.getElementById('bulk-assignment-controls');
    const bulkProjectSelect = document.getElementById('bulk-project-select');
    const bulkTaskSelect = document.getElementById('bulk-task-select');
    const selectAllCheckbox = document.getElementById('select-all-events');
    const bulkAssignBtn = document.getElementById('bulk-assign-btn');

    // Show bulk controls if there are unmapped events
    if (currentUnmappedEvents.length > 0) {
        bulkControls.style.display = 'block';

        // Populate bulk project dropdown
        bulkProjectSelect.innerHTML = '<option value="">Select Project...</option>';
        availableProjects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = `${project.name} (${project.client_name})`;
            bulkProjectSelect.appendChild(option);
        });

        // Setup event listeners
        selectAllCheckbox.addEventListener('change', toggleSelectAll);
        bulkProjectSelect.addEventListener('change', updateBulkTaskOptions);
        bulkAssignBtn.addEventListener('click', performBulkAssignment);
    } else {
        bulkControls.style.display = 'none';
    }
}

function updateBulkControls() {
    const checkboxes = document.querySelectorAll('.event-checkbox:checked');
    const selectedCount = checkboxes.length;
    const selectAllCheckbox = document.getElementById('select-all-events');
    const selectedCountSpan = document.getElementById('selected-count');
    const bulkAssignBtn = document.getElementById('bulk-assign-btn');
    const bulkProjectSelect = document.getElementById('bulk-project-select');
    const bulkTaskSelect = document.getElementById('bulk-task-select');

    // Update selected count
    selectedCountSpan.textContent = selectedCount;

    // Update select all checkbox state
    const totalCheckboxes = document.querySelectorAll('.event-checkbox').length;
    selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCheckboxes;
    selectAllCheckbox.checked = selectedCount === totalCheckboxes && totalCheckboxes > 0;

    // Enable/disable bulk assign button
    const hasSelection = selectedCount > 0;
    const hasProjectAndTask = bulkProjectSelect.value && bulkTaskSelect.value;
    bulkAssignBtn.disabled = !hasSelection || !hasProjectAndTask;
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all-events');
    const eventCheckboxes = document.querySelectorAll('.event-checkbox');

    eventCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });

    updateBulkControls();
}

function updateBulkTaskOptions() {
    const bulkProjectSelect = document.getElementById('bulk-project-select');
    const bulkTaskSelect = document.getElementById('bulk-task-select');
    const projectId = bulkProjectSelect.value;

    bulkTaskSelect.innerHTML = '<option value="">Select Task...</option>';
    bulkTaskSelect.disabled = !projectId;

    if (!projectId) {
        updateBulkControls();
        return;
    }

    // Load tasks for selected project
    fetch(`/api/harvest/projects/${projectId}/tasks`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.tasks) {
                data.tasks.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = task.name;
                    bulkTaskSelect.appendChild(option);
                });
                bulkTaskSelect.disabled = false;
            }
            updateBulkControls();
        })
        .catch(error => {
            console.error('Error loading tasks:', error);
            updateBulkControls();
        });
}

function performBulkAssignment() {
    const selectedCheckboxes = document.querySelectorAll('.event-checkbox:checked');
    const bulkProjectSelect = document.getElementById('bulk-project-select');
    const bulkTaskSelect = document.getElementById('bulk-task-select');

    if (selectedCheckboxes.length === 0) {
        CalendarHarvestApp.showError('Please select at least one event');
        return;
    }

    if (!bulkProjectSelect.value || !bulkTaskSelect.value) {
        CalendarHarvestApp.showError('Please select both project and task');
        return;
    }

    const selectedProject = availableProjects.find(p => p.id == bulkProjectSelect.value);
    const selectedTaskOption = bulkTaskSelect.options[bulkTaskSelect.selectedIndex];

    // Prepare assignments for selected events
    const assignments = [];
    selectedCheckboxes.forEach(checkbox => {
        const eventIndex = parseInt(checkbox.dataset.eventIndex);
        const event = currentUnmappedEvents[eventIndex];

        assignments.push({
            calendar_label: event.extracted_label || event.summary,
            harvest_project_id: parseInt(bulkProjectSelect.value),
            harvest_project_name: selectedProject.name,
            harvest_task_id: parseInt(bulkTaskSelect.value),
            harvest_task_name: selectedTaskOption.textContent
        });
    });

    // Show loading state
    const bulkAssignBtn = document.getElementById('bulk-assign-btn');
    const originalText = bulkAssignBtn.innerHTML;
    bulkAssignBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Assigning...';
    bulkAssignBtn.disabled = true;

    // Perform bulk assignment
    fetch('/api/bulk-mapping/assign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            assignments: assignments
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            CalendarHarvestApp.showSuccess(`Successfully assigned ${assignments.length} event${assignments.length !== 1 ? 's' : ''}`);

            // Refresh the timesheet preview
            generateTimesheetPreview();

            // Reset bulk controls
            document.getElementById('select-all-events').checked = false;
            bulkProjectSelect.value = '';
            bulkTaskSelect.value = '';
            bulkTaskSelect.disabled = true;
        } else {
            CalendarHarvestApp.showError(data.error || 'Failed to perform bulk assignment');
        }
    })
    .catch(error => {
        console.error('Error performing bulk assignment:', error);
        CalendarHarvestApp.showError('Failed to perform bulk assignment');
    })
    .finally(() => {
        bulkAssignBtn.innerHTML = originalText;
        updateBulkControls();
    });
}

function updateTaskOptions(eventIndex) {
    const projectSelect = document.getElementById(`project-select-${eventIndex}`);
    const taskSelect = document.getElementById(`task-select-${eventIndex}`);
    const taskRow = document.getElementById(`task-row-${eventIndex}`);
    const assignBtn = document.getElementById(`assign-btn-${eventIndex}`);

    const projectId = projectSelect.value;

    if (!projectId) {
        taskRow.style.display = 'none';
        assignBtn.disabled = true;
        return;
    }

    // Find the selected project
    const selectedProject = availableProjects.find(p => p.id == projectId);
    if (!selectedProject) return;

    // Show loading state
    taskSelect.innerHTML = '<option value="">Loading tasks...</option>';
    taskRow.style.display = 'block';
    assignBtn.disabled = true;

    // Fetch tasks for the selected project
    fetch(`/api/harvest/projects/${projectId}/tasks`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Populate task options
                taskSelect.innerHTML = '<option value="">Select Task...</option>';
                data.tasks.forEach(task => {
                    taskSelect.innerHTML += `<option value="${task.id}">${task.name}</option>`;
                });

                // Enable assign button when task is selected
                taskSelect.onchange = function() {
                    assignBtn.disabled = !taskSelect.value;
                };
            } else {
                taskSelect.innerHTML = '<option value="">Error loading tasks</option>';
                console.error('Failed to load tasks:', data.error);
            }
        })
        .catch(error => {
            taskSelect.innerHTML = '<option value="">Error loading tasks</option>';
            console.error('Error loading tasks:', error);
        });
}

function getPatternSuggestions(eventIndex) {
    const event = currentUnmappedEvents[eventIndex];
    const suggestBtn = document.getElementById(`suggest-btn-${eventIndex}`);

    // Show loading state
    suggestBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Analyzing...';
    suggestBtn.disabled = true;

    fetch('/api/pattern-suggestions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ event: event })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.suggestions.length > 0) {
            displayPatternSuggestions(eventIndex, data.suggestions);
            CalendarHarvestApp.showSuccess(`Found ${data.suggestions.length} suggestion${data.suggestions.length !== 1 ? 's' : ''}`);
        } else {
            CalendarHarvestApp.showInfo('No pattern-based suggestions found for this event');
        }
    })
    .catch(error => {
        console.error('Error getting pattern suggestions:', error);
        CalendarHarvestApp.showError('Failed to get suggestions');
    })
    .finally(() => {
        // Reset button
        suggestBtn.innerHTML = '<i class="bi bi-lightbulb"></i> Suggest';
        suggestBtn.disabled = false;
    });
}

function displayPatternSuggestions(eventIndex, suggestions) {
    const projectSelect = document.getElementById(`project-select-${eventIndex}`);
    const taskSelect = document.getElementById(`task-select-${eventIndex}`);

    // Auto-select the best suggestion
    const bestSuggestion = suggestions[0];

    // Set project
    projectSelect.value = bestSuggestion.project.id;

    // Load and set task
    updateTaskOptions(eventIndex).then(() => {
        // Try to find a matching task or select the first one
        const taskOptions = taskSelect.options;
        for (let i = 0; i < taskOptions.length; i++) {
            if (taskOptions[i].value) {
                taskSelect.value = taskOptions[i].value;
                break;
            }
        }

        // Enable assign button
        const assignBtn = document.getElementById(`assign-btn-${eventIndex}`);
        assignBtn.disabled = false;

        // Show suggestion info
        const eventDiv = document.querySelector(`#project-select-${eventIndex}`).closest('.unmapped-event');
        let suggestionInfo = eventDiv.querySelector('.suggestion-info');

        if (!suggestionInfo) {
            suggestionInfo = document.createElement('div');
            suggestionInfo.className = 'suggestion-info mt-2';
            eventDiv.appendChild(suggestionInfo);
        }

        suggestionInfo.innerHTML = `
            <div class="alert alert-info alert-sm mb-0">
                <i class="bi bi-lightbulb"></i>
                <strong>Suggestion:</strong> ${bestSuggestion.reasons.join(', ')}
                <small class="d-block">Confidence: ${Math.round(bestSuggestion.score * 100)}%</small>
            </div>
        `;
    });
}

function assignMapping(eventIndex) {
    const projectSelect = document.getElementById(`project-select-${eventIndex}`);
    const taskSelect = document.getElementById(`task-select-${eventIndex}`);

    const projectId = projectSelect.value;
    const taskId = taskSelect.value;

    if (!projectId || !taskId) {
        CalendarHarvestApp.showError('Please select both project and task');
        return;
    }

    const event = currentUnmappedEvents[eventIndex];
    const selectedProject = availableProjects.find(p => p.id == projectId);

    // Get task name from the selected option
    const taskSelectElement = document.getElementById(`task-select-${eventIndex}`);
    const selectedTaskOption = taskSelectElement.options[taskSelectElement.selectedIndex];
    const selectedTask = {
        id: parseInt(taskId),
        name: selectedTaskOption.text
    };

    // Create a mapping for this event
    const mappingData = {
        calendar_label: event.summary, // Use event summary as label
            harvest_project_id: parseInt(projectId),
            harvest_project_name: selectedProject.name,
            harvest_task_id: parseInt(taskId),
            harvest_task_name: selectedTask.name,
            is_active: true
        };

        // Save the mapping
        fetch('/api/mappings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(mappingData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                CalendarHarvestApp.showSuccess(`Mapping created for "${event.summary}"`);
                // Refresh the timesheet preview to include the newly mapped event
                generateTimesheetPreview();
            } else {
                CalendarHarvestApp.showError(data.error || 'Failed to create mapping');
            }
        })
        .catch(error => {
            console.error('Error creating mapping:', error);
            CalendarHarvestApp.showError('Failed to create mapping');
        });
}

function showHarvestPreviewModal() {
    console.log('Showing Harvest preview modal');

    // Reset the main process button since modal is now open
    resetProcessButton();

    // Set up the week title
    const startFormatted = formatDateDisplay(currentWeekStart);
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    const endFormatted = formatDateDisplay(weekEnd);
    document.getElementById('harvestWeekTitle').textContent = `This week: ${startFormatted} – ${endFormatted}`;

    // Set up the day headers
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const dayIds = ['harvestMon', 'harvestTue', 'harvestWed', 'harvestThu', 'harvestFri', 'harvestSat', 'harvestSun'];

    for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(date.getDate() + i);
        const dayStr = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        document.getElementById(dayIds[i]).textContent = dayStr;
    }

    // Populate the timesheet table
    populateHarvestTimesheetTable();

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('harvestPreviewModal'));
    modal.show();
}

function populateHarvestTimesheetTable() {
    const tbody = document.getElementById('harvestTimesheetBody');
    tbody.innerHTML = '';

    // Group entries by project and task
    const groupedEntries = {};

    currentTimesheetEntries.forEach(entry => {
        const key = `${entry.project_name}|${entry.task_name}`;
        if (!groupedEntries[key]) {
            groupedEntries[key] = {
                project_name: entry.project_name,
                task_name: entry.task_name,
                days: [0, 0, 0, 0, 0, 0, 0] // Mon-Sun
            };
        }

        // Calculate which day of the week this entry is for
        const entryDate = new Date(entry.spent_date);
        const weekStart = new Date(currentWeekStart);
        const dayIndex = Math.floor((entryDate - weekStart) / (1000 * 60 * 60 * 24));

        if (dayIndex >= 0 && dayIndex < 7) {
            groupedEntries[key].days[dayIndex] += entry.hours;
        }
    });

    // Create table rows
    Object.values(groupedEntries).forEach(group => {
        const row = document.createElement('tr');

        // Project/Task cell
        const projectCell = document.createElement('td');
        projectCell.className = 'project-cell';
        projectCell.innerHTML = `
            <div class="project-name">${group.project_name}</div>
            <div class="task-name">${group.task_name}</div>
        `;
        row.appendChild(projectCell);

        // Day cells
        let rowTotal = 0;
        group.days.forEach(hours => {
            const dayCell = document.createElement('td');
            dayCell.className = 'text-center';

            if (hours > 0) {
                dayCell.innerHTML = `<input type="text" class="hours-input has-hours" value="${hours}" readonly>`;
                rowTotal += hours;
            } else {
                dayCell.innerHTML = `<input type="text" class="hours-input" value="" readonly>`;
            }

            row.appendChild(dayCell);
        });

        // Total cell
        const totalCell = document.createElement('td');
        totalCell.className = 'text-center total-cell';
        totalCell.textContent = rowTotal > 0 ? rowTotal.toString() : '0';
        row.appendChild(totalCell);

        // Delete cell (disabled)
        const deleteCell = document.createElement('td');
        deleteCell.className = 'text-center';
        deleteCell.innerHTML = '<button class="btn btn-sm btn-outline-danger" disabled><i class="bi bi-x"></i></button>';
        row.appendChild(deleteCell);

        tbody.appendChild(row);
    });

    // Update totals
    updateHarvestTotals(groupedEntries);
}

function updateHarvestTotals(groupedEntries) {
    const dayTotals = [0, 0, 0, 0, 0, 0, 0];
    let grandTotal = 0;

    Object.values(groupedEntries).forEach(group => {
        group.days.forEach((hours, index) => {
            dayTotals[index] += hours;
            grandTotal += hours;
        });
    });

    // Update footer totals
    const totalIds = ['harvestTotalMon', 'harvestTotalTue', 'harvestTotalWed', 'harvestTotalThu', 'harvestTotalFri', 'harvestTotalSat', 'harvestTotalSun'];
    dayTotals.forEach((total, index) => {
        document.getElementById(totalIds[index]).textContent = total > 0 ? total.toString() : '0';
    });

    document.getElementById('harvestGrandTotal').textContent = grandTotal > 0 ? grandTotal.toString() : '0';
}



function processTimesheets() {
    console.log('=== PROCESSING TIMESHEETS DEBUG ===');
    console.log('Current timesheet entries:', currentTimesheetEntries);
    console.log('Current timesheet entries length:', currentTimesheetEntries.length);

    // Add loading state to the main process button
    const processBtn = document.getElementById('process-btn');
    if (processBtn) {
        processBtn.disabled = true;
        processBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Loading...';
    }

    if (currentTimesheetEntries.length === 0) {
        console.log('❌ No timesheet entries to process');
        CalendarHarvestApp.showError('No timesheet entries to process');
        resetProcessButton();
        return;
    }

    // Show confirmation with exact week being processed
    const startFormatted = formatDateDisplay(currentWeekStart);
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    const endFormatted = formatDateDisplay(weekEnd);

    const isDryRun = document.getElementById('dryRun').checked;

    if (isDryRun) {
        // Show Harvest timesheet preview modal
        showHarvestPreviewModal();
        return;
    }

    // Show safety confirmation modal instead of simple confirm
    console.log('🔄 About to show safety confirmation modal - VERSION 3.0 - TIMESTAMP: ' + new Date().toISOString());
    showSafetyConfirmationModal(startFormatted, endFormatted);
}

// Safety Confirmation Modal Functions
function showSafetyConfirmationModal(startFormatted, endFormatted) {
    console.log('🛡️ Showing safety confirmation modal - v2.0');

    // Reset the main process button since modal is now open
    resetProcessButton();

    // Calculate total hours
    const totalHours = currentTimesheetEntries.reduce((sum, entry) => sum + entry.hours, 0);

    // Update modal content
    document.getElementById('confirmWeekRange').textContent = `${startFormatted} - ${endFormatted}`;
    document.getElementById('confirmEntryCount').textContent = `${currentTimesheetEntries.length} entries`;
    document.getElementById('confirmTotalHours').textContent = `${totalHours.toFixed(1)} hours`;

    // Reset modal state
    document.getElementById('confirmProcessButton').disabled = true;
    document.getElementById('safetyError').classList.add('d-none');

    // Show loading states
    document.getElementById('harvestAccountInfo').innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Verifying Harvest account...</span>
        </div>
    `;

    document.getElementById('safetyChecks').innerHTML = `
        <div class="d-flex align-items-center mb-1">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Running safety checks...</span>
        </div>
    `;

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('safetyConfirmationModal'));
    modal.show();

    // Load Harvest user info and run safety checks
    loadHarvestUserInfoForConfirmation();
}

function loadHarvestUserInfoForConfirmation() {
    console.log('🔍 Loading Harvest user info for confirmation');

    fetch('/api/harvest/user-info')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display Harvest account info
                const harvestUser = data.harvest_user;
                const harvestAccount = data.harvest_account;

                document.getElementById('harvestAccountInfo').innerHTML = `
                    <div class="border rounded p-3 bg-light">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-person-circle text-success me-2"></i>
                            <strong>${harvestUser.full_name || harvestUser.email}</strong>
                        </div>
                        <div class="small text-muted">
                            <div><strong>Email:</strong> ${harvestUser.email}</div>
                            <div><strong>User ID:</strong> ${harvestUser.id}</div>
                            <div><strong>Account:</strong> ${harvestAccount.name}${harvestAccount.id ? ` (ID: ${harvestAccount.id})` : ''}</div>
                        </div>
                    </div>
                `;

                // Show safety checks passed
                document.getElementById('safetyChecks').innerHTML = `
                    <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <span>User identity verified</span>
                    </div>
                    <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <span>Account isolation confirmed</span>
                    </div>
                    <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <span>OAuth credentials validated</span>
                    </div>
                `;

                // Enable the confirm button
                document.getElementById('confirmProcessButton').disabled = false;

            } else {
                // Show error
                document.getElementById('safetyError').classList.remove('d-none');
                document.getElementById('safetyErrorMessage').textContent = data.error;

                document.getElementById('harvestAccountInfo').innerHTML = `
                    <div class="text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Failed to verify Harvest account
                    </div>
                `;

                document.getElementById('safetyChecks').innerHTML = `
                    <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-x-circle text-danger me-2"></i>
                        <span>Safety verification failed</span>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading Harvest user info:', error);

            document.getElementById('safetyError').classList.remove('d-none');
            document.getElementById('safetyErrorMessage').textContent = 'Network error while verifying Harvest account';

            document.getElementById('harvestAccountInfo').innerHTML = `
                <div class="text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Network error
                </div>
            `;
        });
}

function executeTimesheetProcessing() {
    console.log('🚀 Executing timesheet processing after safety confirmation');
    console.log('🔧 DEBUG: Current timesheet entries:', currentTimesheetEntries);
    console.log('🔧 DEBUG: Current timesheet entries length:', currentTimesheetEntries.length);
    console.log('🔧 DEBUG: Current week start:', currentWeekStart);

    // Additional validation
    if (!currentTimesheetEntries || currentTimesheetEntries.length === 0) {
        console.error('❌ CRITICAL: No timesheet entries to process!');
        CalendarHarvestApp.showError('No timesheet entries to process');
        return;
    }

    // Disable the confirm button and show loading state
    const confirmButton = document.getElementById('confirmProcessButton');
    if (confirmButton) {
        confirmButton.disabled = true;
        confirmButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Processing...';
    }

    // Show loading overlay
    CalendarHarvestApp.showLoading('Processing timesheet entries...');

    console.log('🚀 SENDING PROCESSING REQUEST to /api/process/execute');
    console.log('📦 Request payload:', {
        week_start: formatDate(currentWeekStart),
        timesheet_entries: currentTimesheetEntries,
        force_overwrite: false
    });

    const isDryRun = document.getElementById('dryRun').checked;
    const requestPayload = {
        week_start: currentWeekStart.toISOString().split('T')[0],
        timesheet_entries: currentTimesheetEntries,
        options: {
            force_overwrite: false,
            preview_mode: isDryRun
        }
    };

    console.log('📤 SENDING PROCESSING REQUEST:');
    console.log('  - Week start:', requestPayload.week_start);
    console.log('  - Entries count:', requestPayload.timesheet_entries.length);
    console.log('  - Sample entries:', requestPayload.timesheet_entries.slice(0, 2));
    console.log('  - Full payload:', requestPayload);

    fetch('/api/process/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(requestPayload)
    })
    .then(response => {
        console.log('📨 PROCESSING RESPONSE received:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('📊 PROCESSING RESPONSE DATA:', data);
        console.log('🔍 DETAILED RESPONSE ANALYSIS:');
        console.log('  - Success:', data.success);
        console.log('  - Total entries:', data.total_entries);
        console.log('  - Successful:', data.successful_entries);
        console.log('  - Skipped:', data.skipped_entries);
        console.log('  - Failed:', data.failed_entries);
        console.log('  - Errors:', data.errors);
        console.log('  - Created entries:', data.created_entries);

        CalendarHarvestApp.hideLoading();
        resetConfirmButton();

        // Hide the safety confirmation modal
        const safetyModal = bootstrap.Modal.getInstance(document.getElementById('safetyConfirmationModal'));
        if (safetyModal) {
            safetyModal.hide();
        }

        // Show the comprehensive results modal
        showProcessingResultsModal(data);

        // Regenerate the timesheet preview to refresh the state
        setTimeout(() => {
            generateTimesheetPreview();
        }, 1000);
    })
    .catch(error => {
        console.error('🚨 PROCESSING REQUEST FAILED:', error);
        CalendarHarvestApp.hideLoading();
        resetConfirmButton();

        // Hide the safety confirmation modal
        const safetyModal = bootstrap.Modal.getInstance(document.getElementById('safetyConfirmationModal'));
        if (safetyModal) {
            safetyModal.hide();
        }

        // Show error in results modal format
        const errorData = {
            success: false,
            total_entries: currentTimesheetEntries ? currentTimesheetEntries.length : 0,
            successful_entries: 0,
            skipped_entries: 0,
            failed_entries: currentTimesheetEntries ? currentTimesheetEntries.length : 0,
            errors: [`Network error: ${error.message}`],
            created_entries: [],
            api_log: [{
                timestamp: new Date().toISOString(),
                type: 'ERROR',
                method: 'POST',
                url: '/api/process/execute',
                status: 'NETWORK_ERROR',
                data: { error: error.message }
            }]
        };

        showProcessingResultsModal(errorData);
    });
}

function resetConfirmButton() {
    const confirmButton = document.getElementById('confirmProcessButton');
    if (confirmButton) {
        confirmButton.disabled = false;
        confirmButton.innerHTML = 'Yes, Process Entries';
    }
}

function showProcessingResultsModal(data) {
    console.log('📋 Showing processing results modal');

    // Determine overall status
    const isSuccess = data.success && data.failed_entries === 0;
    const hasPartialSuccess = data.successful_entries > 0 && data.failed_entries > 0;
    const isCompleteFailure = data.successful_entries === 0 && data.failed_entries > 0;

    // Update modal title and status
    const modalTitle = document.getElementById('resultsModalTitle');
    const statusIcon = document.getElementById('resultsStatusIcon');
    const statusText = document.getElementById('resultsStatusText');

    if (isSuccess) {
        modalTitle.textContent = 'Processing Completed Successfully';
        statusIcon.innerHTML = '<i class="bi bi-check-circle-fill text-success fs-1"></i>';
        statusText.innerHTML = '<span class="text-success fw-bold">All entries processed successfully!</span>';
    } else if (hasPartialSuccess) {
        modalTitle.textContent = 'Processing Completed with Issues';
        statusIcon.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-warning fs-1"></i>';
        statusText.innerHTML = '<span class="text-warning fw-bold">Some entries processed successfully, others failed</span>';
    } else if (isCompleteFailure) {
        modalTitle.textContent = 'Processing Failed';
        statusIcon.innerHTML = '<i class="bi bi-x-circle-fill text-danger fs-1"></i>';
        statusText.innerHTML = '<span class="text-danger fw-bold">Processing failed - no entries were created</span>';
    } else {
        modalTitle.textContent = 'Processing Results';
        statusIcon.innerHTML = '<i class="bi bi-info-circle-fill text-info fs-1"></i>';
        statusText.innerHTML = '<span class="text-info fw-bold">Processing completed</span>';
    }

    // Update summary statistics
    document.getElementById('resultsTotalEntries').textContent = data.total_entries || 0;
    document.getElementById('resultsSuccessfulEntries').textContent = data.successful_entries || 0;
    document.getElementById('resultsSkippedEntries').textContent = data.skipped_entries || 0;
    document.getElementById('resultsFailedEntries').textContent = data.failed_entries || 0;

    // Calculate total hours
    const totalHours = (data.created_entries || []).reduce((sum, entry) => sum + (entry.hours || 0), 0);
    document.getElementById('resultsTotalHours').textContent = totalHours.toFixed(1);

    // Show/hide summary rows based on data
    document.getElementById('resultsSkippedRow').style.display = (data.skipped_entries > 0) ? 'table-row' : 'none';
    document.getElementById('resultsFailedRow').style.display = (data.failed_entries > 0) ? 'table-row' : 'none';

    // Populate created entries details
    const createdEntriesContainer = document.getElementById('resultsCreatedEntries');
    if (data.created_entries && data.created_entries.length > 0) {
        createdEntriesContainer.innerHTML = data.created_entries.map(entry => `
            <div class="border rounded p-2 mb-2 bg-light">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="fw-bold text-truncate">${entry.event_summary || 'Untitled Event'}</div>
                        <div class="small text-muted">
                            <i class="bi bi-folder"></i> ${entry.project_name || 'Unknown Project'}
                            <i class="bi bi-list-task ms-2"></i> ${entry.task_name || 'Unknown Task'}
                        </div>
                        <div class="small text-muted">
                            <i class="bi bi-calendar"></i> ${entry.spent_date}
                            ${entry.harvest_id ? `<i class="bi bi-hash ms-2"></i> ${entry.harvest_id}` : ''}
                        </div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success">${entry.hours}h</span>
                    </div>
                </div>
            </div>
        `).join('');
        document.getElementById('resultsCreatedSection').style.display = 'block';
    } else {
        document.getElementById('resultsCreatedSection').style.display = 'none';
    }

    // Populate error details
    const errorsContainer = document.getElementById('resultsErrorDetails');
    if (data.errors && data.errors.length > 0) {
        errorsContainer.innerHTML = data.errors.map((error, index) => `
            <div class="alert alert-danger py-2 mb-2">
                <small><strong>Error ${index + 1}:</strong> ${error}</small>
            </div>
        `).join('');
        document.getElementById('resultsErrorSection').style.display = 'block';
    } else {
        document.getElementById('resultsErrorSection').style.display = 'none';
    }

    // Generate API log
    generateAPILog(data);

    // Set appropriate active tab based on results
    const createdTab = document.getElementById('created-tab');
    const errorsTab = document.getElementById('errors-tab');
    const apiLogTab = document.getElementById('api-log-tab');

    // Reset all tabs
    document.querySelectorAll('#resultsTab .nav-link').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('#resultsTabContent .tab-pane').forEach(pane => {
        pane.classList.remove('show', 'active');
    });

    // Show appropriate tab based on results
    if (data.failed_entries > 0) {
        // Show errors tab if there are failures
        errorsTab.classList.add('active');
        document.getElementById('error-details').classList.add('show', 'active');
    } else if (data.successful_entries > 0) {
        // Show created entries tab if there are successes
        createdTab.classList.add('active');
        document.getElementById('created-entries').classList.add('show', 'active');
    } else {
        // Default to API log tab
        apiLogTab.classList.add('active');
        document.getElementById('api-log').classList.add('show', 'active');
    }

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('processingResultsModal'));
    modal.show();
}

function generateAPILog(data) {
    console.log('📝 Generating API log for results modal');

    const apiLogContainer = document.getElementById('resultsAPILog');

    // Use real API log data from backend if available
    let logEntries = data.api_log || [];

    // If no API log data, show a message
    if (logEntries.length === 0) {
        apiLogContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-info-circle fs-1"></i>
                <p>No API log data available for this processing session.</p>
            </div>
        `;
        return;
    }

    // Sort by timestamp
    logEntries.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    // Generate HTML
    apiLogContainer.innerHTML = logEntries.map(entry => {
        const statusClass = entry.status === 'SUCCESS' ? 'text-success' :
                           entry.status === 'ERROR' ? 'text-danger' :
                           entry.status === 'SENT' || entry.status === 'RECEIVED' ? 'text-info' :
                           entry.status === 'PARTIAL_SUCCESS' ? 'text-warning' : 'text-muted';

        const typeIcon = entry.type.includes('REQUEST') ? '📤' : '📥';
        const methodBadge = entry.method ? `<span class="badge bg-secondary me-1">${entry.method}</span>` : '';

        // Handle different URL formats
        const displayUrl = entry.url || 'Unknown URL';

        // Format timestamp
        const timestamp = new Date(entry.timestamp);
        const timeString = timestamp.toLocaleTimeString() + '.' + timestamp.getMilliseconds().toString().padStart(3, '0');

        return `
            <div class="border-bottom py-2">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <div class="small">
                        ${typeIcon} ${methodBadge}
                        <span class="font-monospace">${displayUrl}</span>
                    </div>
                    <div class="small text-muted">${timeString}</div>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="small ${statusClass} fw-bold">${entry.status}</span>
                    ${entry.status_code ? `<span class="badge bg-light text-dark">${entry.status_code}</span>` : ''}
                </div>
                ${entry.error ? `<div class="small text-danger mt-1"><i class="bi bi-exclamation-triangle"></i> ${entry.error}</div>` : ''}
                <details class="mt-1">
                    <summary class="small text-muted" style="cursor: pointer;">Show data</summary>
                    <pre class="small bg-light p-2 mt-1 rounded" style="font-size: 0.75rem; max-height: 200px; overflow-y: auto;"><code>${JSON.stringify(entry.data || {}, null, 2)}</code></pre>
                </details>
            </div>
        `;
    }).join('');
}

function resetProcessButton() {
    const processBtn = document.getElementById('process-btn');
    if (processBtn) {
        // Preserve the current week indicator text
        const weekIndicator = document.getElementById('process-week-indicator');
        const weekText = weekIndicator ? weekIndicator.textContent : '';

        processBtn.disabled = false;
        processBtn.innerHTML = `
            <i class="bi bi-play-fill"></i>
            Process Timesheets
            <div class="small" id="process-week-indicator" style="opacity: 0.8; margin-top: 2px;">
                ${weekText}
            </div>
        `;
    }
}

function resetProcessingModal() {
    // Reset progress bar
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = '0%';
    progressBar.classList.add('progress-bar-animated');

    // Show processing status, hide results
    const statusElement = document.getElementById('processing-status');
    const resultsElement = document.getElementById('processing-results');
    const closeButton = document.getElementById('close-processing');

    statusElement.style.display = 'block';
    resultsElement.style.display = 'none';
    closeButton.style.display = 'none';

    // Clear any previous results
    resultsElement.innerHTML = '';

    // Start progress animation
    setTimeout(() => {
        progressBar.style.width = '30%';
    }, 100);
}

function displayProcessingResults(data) {
    const progressBar = document.getElementById('progress-bar');
    const statusElement = document.getElementById('processing-status');
    const resultsElement = document.getElementById('processing-results');
    const closeButton = document.getElementById('close-processing');
    
    progressBar.style.width = '100%';
    progressBar.classList.remove('progress-bar-animated');
    
    statusElement.style.display = 'none';
    resultsElement.style.display = 'block';
    closeButton.style.display = 'block';
    
    if (data.success) {
        resultsElement.innerHTML = `
            <div class="alert alert-success">
                <h6><i class="bi bi-check-circle"></i> Processing Complete!</h6>
                <ul class="mb-0">
                    <li>Created: ${data.created_count || 0} timesheet entries</li>
                    <li>Skipped: ${data.skipped_count || 0} entries</li>
                    <li>Errors: ${data.error_count || 0} entries</li>
                </ul>
            </div>
            ${data.errors && data.errors.length > 0 ? `
                <div class="alert alert-warning">
                    <h6>Errors:</h6>
                    <ul class="mb-0">
                        ${data.errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        `;

        // Refresh the timesheet preview after successful processing
        if (data.created_count > 0) {
            setTimeout(() => {
                loadWeekData(currentWeekStart);
            }, 1000);
        }
    } else {
        resultsElement.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="bi bi-x-circle"></i> Processing Failed</h6>
                <p class="mb-0">${data.error || 'Unknown error occurred'}</p>
            </div>
        `;
    }
}

// Navigation functions
document.addEventListener('click', (e) => {
    if (e.target.matches('.week-prev') || e.target.closest('.week-prev')) {
        navigateWeek(-1);
    } else if (e.target.matches('.week-next') || e.target.closest('.week-next')) {
        navigateWeek(1);
    }
});

function navigateWeek(direction) {
    if (!currentWeekStart) return;

    // Cancel any active request immediately
    if (activeRequest) {
        activeRequest.abort();
        activeRequest = null;
    }

    // Clear any pending navigation
    if (navigationTimeout) {
        clearTimeout(navigationTimeout);
    }

    const newWeekStart = new Date(currentWeekStart);
    newWeekStart.setDate(newWeekStart.getDate() + (direction * 7));

    // Update the display immediately for responsiveness
    setCurrentWeek(newWeekStart);

    // Immediately load events if cached, otherwise debounce
    const weekStartStr = formatDate(newWeekStart);
    if (eventsCache.has(weekStartStr)) {
        // Load immediately from cache
        loadWeekEvents();
    } else {
        // Debounce API calls to prevent rapid successive requests
        navigationTimeout = setTimeout(() => {
            loadWeekEvents();
            navigationTimeout = null;
        }, 100); // Reduced to 100ms for better responsiveness
    }
}

// Format date for display (DD-MM-YYYY)
function formatDateDisplay(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}-${month}-${year}`;
}

// Format date for ISO string (YYYY-MM-DD) - for API calls
function formatDateISO(date) {
    // Use local date components to avoid timezone conversion issues
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Legacy function for backward compatibility
function formatDate(date) {
    return formatDateISO(date);
}

// Get week number
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// Check if the given week start is the current week
function isCurrentWeekCheck(weekStart) {
    const today = new Date();
    const currentMonday = new Date(today);
    currentMonday.setDate(today.getDate() - today.getDay() + 1);
    currentMonday.setHours(0, 0, 0, 0);

    const checkMonday = new Date(weekStart);
    checkMonday.setHours(0, 0, 0, 0);

    return currentMonday.getTime() === checkMonday.getTime();
}

// Create colored badge for calendar labels
function createColoredBadge(label) {
    if (!label) return '';
    return `<span class="badge ms-2 ${CalendarHarvestApp.getLabelCssClass(label)}">${label}</span>`;
}

// Handle "Proceed with Actual Submission" button
document.addEventListener('DOMContentLoaded', function() {
    const proceedButton = document.getElementById('proceedWithActualSubmission');
    if (proceedButton) {
        proceedButton.addEventListener('click', function() {
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('harvestPreviewModal'));
            modal.hide();

            // Uncheck the preview mode
            document.getElementById('dryRun').checked = false;

            // Proceed with actual submission
            setTimeout(() => {
                processTimesheets();
            }, 300); // Small delay to allow modal to close
        });
    }
});

// Handle confirm button click
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 DEBUG: DOMContentLoaded event fired');
    const confirmButton = document.getElementById('confirmProcessButton');
    if (confirmButton) {
        console.log('🔧 DEBUG: Confirm button found, adding click listener');
        confirmButton.addEventListener('click', function() {
            console.log('✅ User confirmed processing with safety verification');
            console.log('🔧 DEBUG: Button clicked, proceeding with processing');

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('safetyConfirmationModal'));
            if (modal) {
                modal.hide();
            }

            // Proceed with actual processing
            executeTimesheetProcessing();
        });
    } else {
        console.error('❌ DEBUG: Confirm button not found!');
    }
});

function showExistingEntriesInHarvest() {
    console.log('🔍 Checking existing entries in Harvest for current week...');

    const weekStart = formatDate(currentWeekStart);
    const weekEnd = formatDate(new Date(currentWeekStart.getTime() + 6 * 24 * 60 * 60 * 1000));

    fetch(`/api/harvest/time-entries?start_date=${weekStart}&end_date=${weekEnd}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('📊 EXISTING HARVEST ENTRIES:', data.entries);
                console.log(`Found ${data.entries.length} existing entries in Harvest for week ${weekStart} - ${weekEnd}`);

                // Group by date for easier comparison
                const entriesByDate = {};
                data.entries.forEach(entry => {
                    if (!entriesByDate[entry.spent_date]) {
                        entriesByDate[entry.spent_date] = [];
                    }
                    entriesByDate[entry.spent_date].push(entry);
                });

                console.log('📅 ENTRIES BY DATE:', entriesByDate);

                // Show summary
                let summary = `Existing Harvest entries for ${weekStart} - ${weekEnd}:\n\n`;
                Object.keys(entriesByDate).sort().forEach(date => {
                    summary += `${date}:\n`;
                    entriesByDate[date].forEach(entry => {
                        summary += `  - ${entry.project_name} / ${entry.task_name}: ${entry.hours}h\n`;
                    });
                    summary += '\n';
                });

                alert(summary);
            } else {
                console.error('Failed to fetch existing entries:', data.error);
                alert('Failed to fetch existing entries: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching existing entries:', error);
            alert('Error fetching existing entries: ' + error.message);
        });
}

// Collapsible sections functionality
let eventsCollapsed = true;
let timesheetCollapsed = true;
const MAX_VISIBLE_ITEMS = 5;

function toggleEventsDisplay() {
    const container = document.getElementById('events-container');
    const button = document.querySelector('#events-show-more button');
    const icon = button.querySelector('i');

    eventsCollapsed = !eventsCollapsed;

    if (eventsCollapsed) {
        // Show only first MAX_VISIBLE_ITEMS events
        const events = container.querySelectorAll('.event-preview');
        events.forEach((event, index) => {
            event.style.display = index < MAX_VISIBLE_ITEMS ? 'block' : 'none';
        });
        button.innerHTML = '<i class="bi bi-chevron-down"></i> Show More Events';
    } else {
        // Show all events
        const events = container.querySelectorAll('.event-preview');
        events.forEach(event => {
            event.style.display = 'block';
        });
        button.innerHTML = '<i class="bi bi-chevron-up"></i> Show Less Events';
    }
}

function toggleTimesheetDisplay() {
    const container = document.getElementById('timesheet-container');
    const button = document.querySelector('#timesheet-show-more button');
    const icon = button.querySelector('i');

    timesheetCollapsed = !timesheetCollapsed;

    if (timesheetCollapsed) {
        // Show only first MAX_VISIBLE_ITEMS entries
        const entries = container.querySelectorAll('.timesheet-preview');
        entries.forEach((entry, index) => {
            entry.style.display = index < MAX_VISIBLE_ITEMS ? 'block' : 'none';
        });
        button.innerHTML = '<i class="bi bi-chevron-down"></i> Show More Entries';
    } else {
        // Show all entries
        const entries = container.querySelectorAll('.timesheet-preview');
        entries.forEach(entry => {
            entry.style.display = 'block';
        });
        button.innerHTML = '<i class="bi bi-chevron-up"></i> Show Less Entries';
    }
}

</script>

<!-- Harvest Timesheet Preview Modal -->
<div class="modal fade" id="harvestPreviewModal" tabindex="-1" aria-labelledby="harvestPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="harvestPreviewModalLabel">
                    <i class="bi bi-calendar-week"></i>
                    Harvest Timesheet Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    This shows how your Harvest timesheet would look after processing these entries.
                    <strong>No actual entries will be created in preview mode.</strong>
                </div>

                <!-- Week Navigation Header -->
                <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary btn-sm me-2">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <h6 class="mb-0" id="harvestWeekTitle">This week: 28 Jul – 03 Aug 2025</h6>
                        <button class="btn btn-outline-secondary btn-sm ms-2">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="harvestView" id="harvestDay" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="harvestDay">Day</label>
                        <input type="radio" class="btn-check" name="harvestView" id="harvestWeek" autocomplete="off" checked>
                        <label class="btn btn-outline-primary btn-sm" for="harvestWeek">Week</label>
                    </div>
                </div>

                <!-- Timesheet Table -->
                <div class="table-responsive">
                    <table class="table table-bordered harvest-timesheet-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 300px;">Project / Task</th>
                                <th class="text-center" style="width: 80px;">Mon<br><small class="text-muted" id="harvestMon">28 Jul</small></th>
                                <th class="text-center" style="width: 80px;">Tue<br><small class="text-muted" id="harvestTue">29 Jul</small></th>
                                <th class="text-center" style="width: 80px;">Wed<br><small class="text-muted" id="harvestWed">30 Jul</small></th>
                                <th class="text-center" style="width: 80px;">Thu<br><small class="text-muted" id="harvestThu">31 Jul</small></th>
                                <th class="text-center" style="width: 80px;">Fri<br><small class="text-muted" id="harvestFri">01 Aug</small></th>
                                <th class="text-center" style="width: 80px;">Sat<br><small class="text-muted" id="harvestSat">02 Aug</small></th>
                                <th class="text-center" style="width: 80px;">Sun<br><small class="text-muted" id="harvestSun">03 Aug</small></th>
                                <th class="text-center" style="width: 60px;">Total</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="harvestTimesheetBody">
                            <!-- Timesheet rows will be populated here -->
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td><strong>Total</strong></td>
                                <td class="text-center"><strong id="harvestTotalMon">0</strong></td>
                                <td class="text-center"><strong id="harvestTotalTue">0</strong></td>
                                <td class="text-center"><strong id="harvestTotalWed">0</strong></td>
                                <td class="text-center"><strong id="harvestTotalThu">0</strong></td>
                                <td class="text-center"><strong id="harvestTotalFri">0</strong></td>
                                <td class="text-center"><strong id="harvestTotalSat">0</strong></td>
                                <td class="text-center"><strong id="harvestTotalSun">0</strong></td>
                                <td class="text-center"><strong id="harvestGrandTotal">0</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Action Buttons (simulated) -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <button class="btn btn-outline-secondary btn-sm" disabled>
                        <i class="bi bi-plus"></i> Add row
                    </button>
                    <div>
                        <button class="btn btn-success btn-sm me-2" disabled>Save</button>
                        <button class="btn btn-outline-primary btn-sm" disabled>Submit week for approval</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close Preview</button>
                <button type="button" class="btn btn-primary" id="proceedWithActualSubmission">
                    <i class="bi bi-check-circle"></i>
                    Proceed with Actual Submission
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Safety Confirmation Modal -->
<div class="modal fade" id="safetyConfirmationModal" tabindex="-1" aria-labelledby="safetyConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="safetyConfirmationModalLabel">
                    <i class="bi bi-shield-exclamation"></i>
                    Confirm Timesheet Processing
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Important:</strong> You are about to create actual time entries in Harvest. Please verify the details below.
                </div>

                <!-- Processing Summary -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="bi bi-calendar-week"></i> Processing Summary</h6>
                        <ul class="list-unstyled">
                            <li><strong>Week:</strong> <span id="confirmWeekRange"></span></li>
                            <li><strong>Entries:</strong> <span id="confirmEntryCount"></span></li>
                            <li><strong>Total Hours:</strong> <span id="confirmTotalHours"></span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-stopwatch"></i> Harvest Account</h6>
                        <div id="harvestAccountInfo">
                            <div class="d-flex align-items-center mb-2">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span>Verifying Harvest account...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Safety Verification -->
                <div class="alert alert-info">
                    <h6><i class="bi bi-shield-check"></i> Safety Verification</h6>
                    <div id="safetyChecks">
                        <div class="d-flex align-items-center mb-1">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Running safety checks...</span>
                        </div>
                    </div>
                </div>

                <div class="alert alert-danger d-none" id="safetyError">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Safety Check Failed:</strong>
                    <span id="safetyErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-success" id="confirmProcessButton" disabled>
                    <i class="bi bi-check-circle"></i>
                    Yes, Process Entries
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Processing Results Modal -->
<div class="modal fade" id="processingResultsModal" tabindex="-1" aria-labelledby="processingResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultsModalTitle">Processing Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Status Section -->
                <div class="text-center mb-4">
                    <div id="resultsStatusIcon" class="mb-2">
                        <i class="bi bi-info-circle-fill text-info fs-1"></i>
                    </div>
                    <div id="resultsStatusText">
                        <span class="text-info fw-bold">Processing completed</span>
                    </div>
                </div>

                <!-- Summary Statistics -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Processing Summary</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm mb-0">
                                    <tr>
                                        <td><i class="bi bi-list-ol"></i> Total Entries:</td>
                                        <td class="text-end fw-bold" id="resultsTotalEntries">0</td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><i class="bi bi-check-circle"></i> Created:</td>
                                        <td class="text-end fw-bold" id="resultsSuccessfulEntries">0</td>
                                    </tr>
                                    <tr id="resultsSkippedRow" class="table-warning">
                                        <td><i class="bi bi-skip-forward"></i> Skipped:</td>
                                        <td class="text-end fw-bold" id="resultsSkippedEntries">0</td>
                                    </tr>
                                    <tr id="resultsFailedRow" class="table-danger">
                                        <td><i class="bi bi-x-circle"></i> Failed:</td>
                                        <td class="text-end fw-bold" id="resultsFailedEntries">0</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-clock"></i> Time Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <div class="display-4 text-primary fw-bold" id="resultsTotalHours">0.0</div>
                                    <div class="text-muted">Total Hours Created</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs for Details -->
                <ul class="nav nav-tabs" id="resultsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="created-tab" data-bs-toggle="tab" data-bs-target="#created-entries" type="button" role="tab">
                            <i class="bi bi-check-circle"></i> Created Entries
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="errors-tab" data-bs-toggle="tab" data-bs-target="#error-details" type="button" role="tab">
                            <i class="bi bi-exclamation-triangle"></i> Errors
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="api-log-tab" data-bs-toggle="tab" data-bs-target="#api-log" type="button" role="tab">
                            <i class="bi bi-code-slash"></i> API Log
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="resultsTabContent">
                    <!-- Created Entries Tab -->
                    <div class="tab-pane fade show active" id="created-entries" role="tabpanel">
                        <div id="resultsCreatedSection">
                            <h6><i class="bi bi-check-circle text-success"></i> Successfully Created Entries</h6>
                            <div id="resultsCreatedEntries" class="mt-2">
                                <!-- Created entries will be populated here -->
                            </div>
                        </div>
                        <div id="resultsNoCreatedEntries" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-info-circle fs-1"></i>
                            <p>No entries were created during this processing session.</p>
                        </div>
                    </div>

                    <!-- Error Details Tab -->
                    <div class="tab-pane fade" id="error-details" role="tabpanel">
                        <div id="resultsErrorSection">
                            <h6><i class="bi bi-exclamation-triangle text-danger"></i> Processing Errors</h6>
                            <div id="resultsErrorDetails" class="mt-2">
                                <!-- Error details will be populated here -->
                            </div>
                        </div>
                        <div id="resultsNoErrors" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-check-circle fs-1 text-success"></i>
                            <p>No errors occurred during processing!</p>
                        </div>
                    </div>

                    <!-- API Log Tab -->
                    <div class="tab-pane fade" id="api-log" role="tabpanel">
                        <h6><i class="bi bi-code-slash"></i> API Exchange Log</h6>
                        <div class="small text-muted mb-2">
                            Complete log of all API requests and responses during processing
                        </div>
                        <div id="resultsAPILog" class="border rounded p-2" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                            <!-- API log will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i>
                    Close
                </button>
                <button type="button" class="btn btn-primary" onclick="generateTimesheetPreview()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Refresh Preview
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.harvest-timesheet-table {
    font-size: 0.9rem;
}

.harvest-timesheet-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    border: 1px solid #dee2e6;
}

.harvest-timesheet-table td {
    border: 1px solid #dee2e6;
    vertical-align: middle;
}

.harvest-timesheet-table .project-cell {
    padding: 12px 8px;
}

.harvest-timesheet-table .project-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 2px;
}

.harvest-timesheet-table .task-name {
    font-size: 0.85rem;
    color: #666;
}

.harvest-timesheet-table .hours-input {
    width: 60px;
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px;
    background-color: #fff;
    font-weight: 500;
}

.harvest-timesheet-table .hours-input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.harvest-timesheet-table .hours-input.has-hours {
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.harvest-timesheet-table .total-cell {
    font-weight: 600;
    color: #333;
}

.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

{% endblock %}
